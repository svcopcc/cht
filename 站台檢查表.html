<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>站台檢查表</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
    th.sticky { position: sticky; top: 0; background: #eee; z-index: 2; }
    td.tsCol { width: 1px; max-width: 1px; font-size: 0.1em; color: transparent; }
    td.green { background-color: #d4edda; }
    td.yellow { background-color: #fff3cd; }
    td.red { background-color: #f8d7da; }
  </style>
</head>
<body>
<h2>📋 站台年度檢查紀錄V13</h2>

<!-- 載入黃色區 -->
<div id="loadingBox" style="background: yellow; padding: 10px; font-weight: bold; margin-top: 1em;">
  ⏳ 正在讀取資料中，請稍候...
</div>
  
<label>選擇年度：
  <select id="yearSelect">
    <option value="114">114</option>
    <option value="113">113</option>
    <option value="112">112</option>
    <option value="custom">自訂</option>
  </select>
  <input type="text" id="customYear" placeholder="輸入年度" style="display:none;">
</label>


<!-- 篩選控制區 -->
<div style="margin-bottom: 1em;">
  <span style="background: yellow; padding: 0.5em;">除錯區</span><br/>
  <button onclick="filterByYear('114')">114</button>
  <button onclick="filterByYear('113')">113</button>
  <button onclick="filterByYear('112')">112</button>
  <input id="customYear" type="text" placeholder="自訂年度" />
  <button onclick="filterByCustomYear()">執行</button>
</div>
  
  
<table id="dataTable">
  <thead><tr id="headerRow"></tr></thead>
  <tbody id="dataBody"></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnvECTbipdQIBkYB1-s4MgjWbTVQc5KkvoQuamlv8u7Q7rUCoV4TMpWfg4v2zowFRQNwhHWDnO9_n1/pub?output=csv';
const headers = ['時間戳記','基地台名稱','轄區','型式','高度(米)','上期維護','本次檢查','檢查與改善',
  '完成日期','備   註','西元檢查日期','評分','私密備註','3G拆台紀錄/施工人員',
  '主體設備(系統/射頻/電力)','Pipe(支)','室外型天線(支)','SMR(組)','Mini shelter/小型機櫃(只)','電錶箱/配電箱(只)','錢錢'];

function toTWDate(iso) {
  const d = new Date(iso);
  return isNaN(d) ? '' : `${d.getFullYear() - 1911}/${d.getMonth() + 1}/${d.getDate()}`;
}
function toDateOnly(dateStr) {
  if (!dateStr || typeof dateStr !== 'string') return '';

  // 移除全形空格、標準化格式
  dateStr = dateStr.replace(/\u3000/g, ' ').replace(/\s+/g, ' ').trim();

  // 先試試看 new Date 能不能吃（有些情況下會支援）
  let d = new Date(dateStr);
  if (!isNaN(d)) {
    return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
  }

  // 嘗試手動解析「2025/1/22 下午5:33:58」
  const match = dateStr.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})\s*(上午|下午)?\s*(\d{1,2}):(\d{2}):(\d{2})$/);
  if (match) {
    let [_, y, m, d2, ampm, h, min, sec] = match;
    h = parseInt(h, 10);
    if (ampm === '下午' && h < 12) h += 12;
    if (ampm === '上午' && h === 12) h = 0;
    const iso = `${y}-${m.padStart?.(2, '0') || m}-${d2.padStart?.(2, '0') || d2}T${String(h).padStart(2, '0')}:${min}:${sec}`;
    d = new Date(iso);
  }

  return isNaN(d) ? '' : `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
}



function getScoreColor(score) {
  if (score === 'S') return 'green';
  if (score === 'A') return 'yellow';
  if (score === 'B') return 'red';
  return '';
}
function getSelectedYear() {
  const sel = document.getElementById('yearSelect').value;
  return sel === 'custom' ? document.getElementById('customYear').value.trim() : sel;
}
document.getElementById('yearSelect').addEventListener('change', () => {
  const customInput = document.getElementById('customYear');
  customInput.style.display = getSelectedYear() === 'custom' ? 'inline' : 'none';
  loadSheet();
});
document.getElementById('customYear').addEventListener('input', loadSheet);

const headerRow = document.getElementById('headerRow');
const tableBody = document.getElementById('dataBody');
headers.forEach(h => {
  const th = document.createElement('th');
  th.textContent = h;
  th.classList.add('sticky');
  if (h === '時間戳記') th.classList.add('tsCol');
  headerRow.appendChild(th);
});

function buildResl(g) {
  let resl = '';
  const 拉線種類 = g['拉線種類'] || '';
  const 拉線數量 = g['拉線數量'] || '';
  const 拉線備註 = g['2-1-1_拉線_備註'] || '';
  const 保養選項 = g['4_保養選項'] || '';
  const 配件備註選擇 = g['3-3.配件_備註'] || '';
  const 其他備註 = g['4_其他_備註'] || '';
  

  resl += g['1-1_鐵塔_角度'] === '合格' ? '鐵塔角度合格，' : '鐵塔角度調整*******，';
  if (g['1-2_鐵塔_防墜器'] === '合格') resl += '防墜器檢查合格，';
  else if (g['1-2_鐵塔_防墜器'] === '無防墜器') resl += '無防墜器，';
  else if (g['1-2_鐵塔_防墜器'] !== '不需防墜器') resl += '防墜器調整，';

  if (g['2-1_拉線'] === '合格') {
    resl += `拉線(${拉線數量}條${拉線種類})檢查合格，`;
  } else {
    resl += `拉線(${拉線數量}條${拉線種類})${g['2-1_拉線']}${拉線備註}，`;
  }

  if (!保養選項.includes("未塗柏油漆")) {
    resl += '配件塗刷柏油漆保養，';
  }

  if (配件備註選擇) resl += 配件備註選擇 + '，';
  if (其他備註) resl += 其他備註 + '，';
  if (g['5_除草'] === '是') resl += '以及除草';

  resl = resl.replace(/，$/, '。').replace(/。$/, '。');
  return resl;
}

  
function loadSheet() {
  // ✅ 顯示載入框 黃色載入區
  document.getElementById('loadingBox').style.display = 'block'; // ✅ 顯示載入框
  
  Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function(res) {
      allRows = res.data;         // 儲存全部資料（後續篩選會用）
      renderTable(allRows);       // 預設載入全部資料
    }
  });
}


  
loadSheet();

let allRows = [];
function filterByYear(year) {
  const filtered = allRows.filter(g => (g['年度設定'] || '').trim() === year);
  renderTable(filtered);
}

function filterByCustomYear() {
  const year = document.getElementById('customYear').value.trim();
  const filtered = allRows.filter(g => (g['年度設定'] || '').trim() === year);
  renderTable(filtered);
}

function renderTable(rows) {
  tableBody.innerHTML = '';

  if (!rows.length) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = headers.length;
    td.textContent = '無資料';
    td.style.textAlign = 'center';
    td.style.background = '#fff3cd';
    tr.appendChild(td);
    tableBody.appendChild(tr);
    return;
  }

  rows.forEach(g => {
    // ✅ 貼上你 loadSheet() 裡的 rows.forEach(g => { ... }) 的原始內容
    let 西元檢查日期來源 = '';
        let 西元檢查日期 = '';

        if ((g['巡檢日期'] || '').trim()) {
          西元檢查日期 = toDateOnly(g['巡檢日期']);
          西元檢查日期來源 = '巡檢日期';
        } else {
          西元檢查日期 = toDateOnly(g['時間戳記']);
          西元檢查日期來源 = '時間戳記';
        }

        console.log(`📌 ${g['站台名稱']} 使用日期來源：${西元檢查日期來源} → ${西元檢查日期}（原始時間戳記：${g['時間戳記']}）`);

        const 本次檢查 = toTWDate(西元檢查日期);
        const 型式 = `${g['鐵塔節數']}節 (${g['鐵塔型態']})`;
        const 高度 = g['鐵塔節數'] === '1.5' ? 8.7 : isNaN(g['鐵塔節數']) ? '*' : (+g['鐵塔節數'] * 5.5).toFixed(1);
        const 拆台 = g['8_3G拆台'] === '由施工股協助拆除' ? g['8_3G拆台'] + ' 施工人員: ' + g['8.2_3G拆台_施工人員'] : '';
        const 私密備註 = g['私密備註'] || g['私密備註 '] || '';
        let aa = 0, bb = 0;
        if (+g['8.1_3G拆台_數量 [主體設備(系統/射頻/電力)]'] >= 1) aa = 500;
        bb += (+g['8.1_3G拆台_數量 [Pipe(支)]'] || 0) * 150;
        bb += (+g['8.1_3G拆台_數量 [室外型天線(支)]'] || 0) * 100;
        bb += (+g['8.1_3G拆台_數量 [SMR(組)]'] || 0) * 300;
        bb += (+g['8.1_3G拆台_數量 [Mini shelter/小型機櫃(只)]'] || 0) * 250;
        bb += (+g['8.1_3G拆台_數量 [電錶箱/配電箱(只)]'] || 0) * 200;
        if (bb > 1500) bb = 1500;
        const 錢錢 = aa + bb;
        const resl = buildResl(g);

        const data = [
          g['時間戳記'], g['站台名稱'], g['轄區(高雄、鳳山....)'], 型式, 高度, '',
          本次檢查, resl, '', '', 西元檢查日期, g['7_評分'], 私密備註,
          拆台, g['8.1_3G拆台_數量 [主體設備(系統/射頻/電力)]'],
          g['8.1_3G拆台_數量 [Pipe(支)]'], g['8.1_3G拆台_數量 [室外型天線(支)]'],
          g['8.1_3G拆台_數量 [SMR(組)]'], g['8.1_3G拆台_數量 [Mini shelter/小型機櫃(只)]'],
          g['8.1_3G拆台_數量 [電錶箱/配電箱(只)]'], 錢錢
        ];

        const tr = document.createElement('tr');
        data.forEach((v, i) => {
          const td = document.createElement('td');
          td.textContent = v || '';
          if (i === 0) td.classList.add('tsCol');
          if (headers[i] === '評分') {
            const cls = getScoreColor(v);
            if (cls) td.classList.add(cls); // 防止空值
          }
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
  });
}


  
</script>
</body>
</html>
