<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç«™å°æª¢æŸ¥è¡¨</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: center; }
    th.sticky { position: sticky; top: 0; background: #eee; z-index: 2; }
    td.tsCol { width: 1px; max-width: 1px; font-size: 0.1em; color: transparent; }
    td.green { background-color: #d4edda; }
    td.yellow { background-color: #fff3cd; }
    td.red { background-color: #f8d7da; }
  </style>
</head>
<body>
<h2>ğŸ“‹ ç«™å°å¹´åº¦æª¢æŸ¥ç´€éŒ„V13</h2>

<!-- è¼‰å…¥é»ƒè‰²å€ -->
<div id="loadingBox" style="background: yellow; padding: 10px; font-weight: bold; margin-top: 1em;">
  â³ æ­£åœ¨è®€å–è³‡æ–™ä¸­ï¼Œè«‹ç¨å€™...
</div>
  
<label>é¸æ“‡å¹´åº¦ï¼š
  <select id="yearSelect">
    <option value="114">114</option>
    <option value="113">113</option>
    <option value="112">112</option>
    <option value="custom">è‡ªè¨‚</option>
  </select>
  <input type="text" id="customYear" placeholder="è¼¸å…¥å¹´åº¦" style="display:none;">
</label>


<!-- ç¯©é¸æ§åˆ¶å€ -->
<div style="margin-bottom: 1em;">
  <span style="background: yellow; padding: 0.5em;">é™¤éŒ¯å€</span><br/>
  <button onclick="filterByYear('114')">114</button>
  <button onclick="filterByYear('113')">113</button>
  <button onclick="filterByYear('112')">112</button>
  <input id="customYear" type="text" placeholder="è‡ªè¨‚å¹´åº¦" />
  <button onclick="filterByCustomYear()">åŸ·è¡Œ</button>
</div>
  
  
<table id="dataTable">
  <thead><tr id="headerRow"></tr></thead>
  <tbody id="dataBody"></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTnvECTbipdQIBkYB1-s4MgjWbTVQc5KkvoQuamlv8u7Q7rUCoV4TMpWfg4v2zowFRQNwhHWDnO9_n1/pub?output=csv';
const headers = ['æ™‚é–“æˆ³è¨˜','åŸºåœ°å°åç¨±','è½„å€','å‹å¼','é«˜åº¦(ç±³)','ä¸ŠæœŸç¶­è­·','æœ¬æ¬¡æª¢æŸ¥','æª¢æŸ¥èˆ‡æ”¹å–„',
  'å®Œæˆæ—¥æœŸ','å‚™   è¨»','è¥¿å…ƒæª¢æŸ¥æ—¥æœŸ','è©•åˆ†','ç§å¯†å‚™è¨»','3Gæ‹†å°ç´€éŒ„/æ–½å·¥äººå“¡',
  'ä¸»é«”è¨­å‚™(ç³»çµ±/å°„é »/é›»åŠ›)','Pipe(æ”¯)','å®¤å¤–å‹å¤©ç·š(æ”¯)','SMR(çµ„)','Mini shelter/å°å‹æ©Ÿæ«ƒ(åª)','é›»éŒ¶ç®±/é…é›»ç®±(åª)','éŒ¢éŒ¢'];

function toTWDate(iso) {
  const d = new Date(iso);
  return isNaN(d) ? '' : `${d.getFullYear() - 1911}/${d.getMonth() + 1}/${d.getDate()}`;
}
function toDateOnly(dateStr) {
  if (!dateStr || typeof dateStr !== 'string') return '';

  // ç§»é™¤å…¨å½¢ç©ºæ ¼ã€æ¨™æº–åŒ–æ ¼å¼
  dateStr = dateStr.replace(/\u3000/g, ' ').replace(/\s+/g, ' ').trim();

  // å…ˆè©¦è©¦çœ‹ new Date èƒ½ä¸èƒ½åƒï¼ˆæœ‰äº›æƒ…æ³ä¸‹æœƒæ”¯æ´ï¼‰
  let d = new Date(dateStr);
  if (!isNaN(d)) {
    return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
  }

  // å˜—è©¦æ‰‹å‹•è§£æã€Œ2025/1/22 ä¸‹åˆ5:33:58ã€
  const match = dateStr.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})\s*(ä¸Šåˆ|ä¸‹åˆ)?\s*(\d{1,2}):(\d{2}):(\d{2})$/);
  if (match) {
    let [_, y, m, d2, ampm, h, min, sec] = match;
    h = parseInt(h, 10);
    if (ampm === 'ä¸‹åˆ' && h < 12) h += 12;
    if (ampm === 'ä¸Šåˆ' && h === 12) h = 0;
    const iso = `${y}-${m.padStart?.(2, '0') || m}-${d2.padStart?.(2, '0') || d2}T${String(h).padStart(2, '0')}:${min}:${sec}`;
    d = new Date(iso);
  }

  return isNaN(d) ? '' : `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
}



function getScoreColor(score) {
  if (score === 'S') return 'green';
  if (score === 'A') return 'yellow';
  if (score === 'B') return 'red';
  return '';
}
function getSelectedYear() {
  const sel = document.getElementById('yearSelect').value;
  return sel === 'custom' ? document.getElementById('customYear').value.trim() : sel;
}
document.getElementById('yearSelect').addEventListener('change', () => {
  const customInput = document.getElementById('customYear');
  customInput.style.display = getSelectedYear() === 'custom' ? 'inline' : 'none';
  loadSheet();
});
document.getElementById('customYear').addEventListener('input', loadSheet);

const headerRow = document.getElementById('headerRow');
const tableBody = document.getElementById('dataBody');
headers.forEach(h => {
  const th = document.createElement('th');
  th.textContent = h;
  th.classList.add('sticky');
  if (h === 'æ™‚é–“æˆ³è¨˜') th.classList.add('tsCol');
  headerRow.appendChild(th);
});

function buildResl(g) {
  let resl = '';
  const æ‹‰ç·šç¨®é¡ = g['æ‹‰ç·šç¨®é¡'] || '';
  const æ‹‰ç·šæ•¸é‡ = g['æ‹‰ç·šæ•¸é‡'] || '';
  const æ‹‰ç·šå‚™è¨» = g['2-1-1_æ‹‰ç·š_å‚™è¨»'] || '';
  const ä¿é¤Šé¸é … = g['4_ä¿é¤Šé¸é …'] || '';
  const é…ä»¶å‚™è¨»é¸æ“‡ = g['3-3.é…ä»¶_å‚™è¨»'] || '';
  const å…¶ä»–å‚™è¨» = g['4_å…¶ä»–_å‚™è¨»'] || '';
  

  resl += g['1-1_éµå¡”_è§’åº¦'] === 'åˆæ ¼' ? 'éµå¡”è§’åº¦åˆæ ¼ï¼Œ' : 'éµå¡”è§’åº¦èª¿æ•´*******ï¼Œ';
  if (g['1-2_éµå¡”_é˜²å¢œå™¨'] === 'åˆæ ¼') resl += 'é˜²å¢œå™¨æª¢æŸ¥åˆæ ¼ï¼Œ';
  else if (g['1-2_éµå¡”_é˜²å¢œå™¨'] === 'ç„¡é˜²å¢œå™¨') resl += 'ç„¡é˜²å¢œå™¨ï¼Œ';
  else if (g['1-2_éµå¡”_é˜²å¢œå™¨'] !== 'ä¸éœ€é˜²å¢œå™¨') resl += 'é˜²å¢œå™¨èª¿æ•´ï¼Œ';

  if (g['2-1_æ‹‰ç·š'] === 'åˆæ ¼') {
    resl += `æ‹‰ç·š(${æ‹‰ç·šæ•¸é‡}æ¢${æ‹‰ç·šç¨®é¡})æª¢æŸ¥åˆæ ¼ï¼Œ`;
  } else {
    resl += `æ‹‰ç·š(${æ‹‰ç·šæ•¸é‡}æ¢${æ‹‰ç·šç¨®é¡})${g['2-1_æ‹‰ç·š']}${æ‹‰ç·šå‚™è¨»}ï¼Œ`;
  }

  if (!ä¿é¤Šé¸é ….includes("æœªå¡—æŸæ²¹æ¼†")) {
    resl += 'é…ä»¶å¡—åˆ·æŸæ²¹æ¼†ä¿é¤Šï¼Œ';
  }

  if (é…ä»¶å‚™è¨»é¸æ“‡) resl += é…ä»¶å‚™è¨»é¸æ“‡ + 'ï¼Œ';
  if (å…¶ä»–å‚™è¨») resl += å…¶ä»–å‚™è¨» + 'ï¼Œ';
  if (g['5_é™¤è‰'] === 'æ˜¯') resl += 'ä»¥åŠé™¤è‰';

  resl = resl.replace(/ï¼Œ$/, 'ã€‚').replace(/ã€‚$/, 'ã€‚');
  return resl;
}

  
function loadSheet() {
  // âœ… é¡¯ç¤ºè¼‰å…¥æ¡† é»ƒè‰²è¼‰å…¥å€
  document.getElementById('loadingBox').style.display = 'block'; // âœ… é¡¯ç¤ºè¼‰å…¥æ¡†
  
  Papa.parse(csvUrl, {
    download: true,
    header: true,
    complete: function(res) {
      allRows = res.data;         // å„²å­˜å…¨éƒ¨è³‡æ–™ï¼ˆå¾ŒçºŒç¯©é¸æœƒç”¨ï¼‰
      renderTable(allRows);       // é è¨­è¼‰å…¥å…¨éƒ¨è³‡æ–™
    }
  });
}


  
loadSheet();

let allRows = [];
function filterByYear(year) {
  const filtered = allRows.filter(g => (g['å¹´åº¦è¨­å®š'] || '').trim() === year);
  renderTable(filtered);
}

function filterByCustomYear() {
  const year = document.getElementById('customYear').value.trim();
  const filtered = allRows.filter(g => (g['å¹´åº¦è¨­å®š'] || '').trim() === year);
  renderTable(filtered);
}

function renderTable(rows) {
  tableBody.innerHTML = '';

  if (!rows.length) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = headers.length;
    td.textContent = 'ç„¡è³‡æ–™';
    td.style.textAlign = 'center';
    td.style.background = '#fff3cd';
    tr.appendChild(td);
    tableBody.appendChild(tr);
    return;
  }

  rows.forEach(g => {
    // âœ… è²¼ä¸Šä½  loadSheet() è£¡çš„ rows.forEach(g => { ... }) çš„åŸå§‹å…§å®¹
    let è¥¿å…ƒæª¢æŸ¥æ—¥æœŸä¾†æº = '';
        let è¥¿å…ƒæª¢æŸ¥æ—¥æœŸ = '';

        if ((g['å·¡æª¢æ—¥æœŸ'] || '').trim()) {
          è¥¿å…ƒæª¢æŸ¥æ—¥æœŸ = toDateOnly(g['å·¡æª¢æ—¥æœŸ']);
          è¥¿å…ƒæª¢æŸ¥æ—¥æœŸä¾†æº = 'å·¡æª¢æ—¥æœŸ';
        } else {
          è¥¿å…ƒæª¢æŸ¥æ—¥æœŸ = toDateOnly(g['æ™‚é–“æˆ³è¨˜']);
          è¥¿å…ƒæª¢æŸ¥æ—¥æœŸä¾†æº = 'æ™‚é–“æˆ³è¨˜';
        }

        console.log(`ğŸ“Œ ${g['ç«™å°åç¨±']} ä½¿ç”¨æ—¥æœŸä¾†æºï¼š${è¥¿å…ƒæª¢æŸ¥æ—¥æœŸä¾†æº} â†’ ${è¥¿å…ƒæª¢æŸ¥æ—¥æœŸ}ï¼ˆåŸå§‹æ™‚é–“æˆ³è¨˜ï¼š${g['æ™‚é–“æˆ³è¨˜']}ï¼‰`);

        const æœ¬æ¬¡æª¢æŸ¥ = toTWDate(è¥¿å…ƒæª¢æŸ¥æ—¥æœŸ);
        const å‹å¼ = `${g['éµå¡”ç¯€æ•¸']}ç¯€ (${g['éµå¡”å‹æ…‹']})`;
        const é«˜åº¦ = g['éµå¡”ç¯€æ•¸'] === '1.5' ? 8.7 : isNaN(g['éµå¡”ç¯€æ•¸']) ? '*' : (+g['éµå¡”ç¯€æ•¸'] * 5.5).toFixed(1);
        const æ‹†å° = g['8_3Gæ‹†å°'] === 'ç”±æ–½å·¥è‚¡å”åŠ©æ‹†é™¤' ? g['8_3Gæ‹†å°'] + ' æ–½å·¥äººå“¡: ' + g['8.2_3Gæ‹†å°_æ–½å·¥äººå“¡'] : '';
        const ç§å¯†å‚™è¨» = g['ç§å¯†å‚™è¨»'] || g['ç§å¯†å‚™è¨» '] || '';
        let aa = 0, bb = 0;
        if (+g['8.1_3Gæ‹†å°_æ•¸é‡ [ä¸»é«”è¨­å‚™(ç³»çµ±/å°„é »/é›»åŠ›)]'] >= 1) aa = 500;
        bb += (+g['8.1_3Gæ‹†å°_æ•¸é‡ [Pipe(æ”¯)]'] || 0) * 150;
        bb += (+g['8.1_3Gæ‹†å°_æ•¸é‡ [å®¤å¤–å‹å¤©ç·š(æ”¯)]'] || 0) * 100;
        bb += (+g['8.1_3Gæ‹†å°_æ•¸é‡ [SMR(çµ„)]'] || 0) * 300;
        bb += (+g['8.1_3Gæ‹†å°_æ•¸é‡ [Mini shelter/å°å‹æ©Ÿæ«ƒ(åª)]'] || 0) * 250;
        bb += (+g['8.1_3Gæ‹†å°_æ•¸é‡ [é›»éŒ¶ç®±/é…é›»ç®±(åª)]'] || 0) * 200;
        if (bb > 1500) bb = 1500;
        const éŒ¢éŒ¢ = aa + bb;
        const resl = buildResl(g);

        const data = [
          g['æ™‚é–“æˆ³è¨˜'], g['ç«™å°åç¨±'], g['è½„å€(é«˜é›„ã€é³³å±±....)'], å‹å¼, é«˜åº¦, '',
          æœ¬æ¬¡æª¢æŸ¥, resl, '', '', è¥¿å…ƒæª¢æŸ¥æ—¥æœŸ, g['7_è©•åˆ†'], ç§å¯†å‚™è¨»,
          æ‹†å°, g['8.1_3Gæ‹†å°_æ•¸é‡ [ä¸»é«”è¨­å‚™(ç³»çµ±/å°„é »/é›»åŠ›)]'],
          g['8.1_3Gæ‹†å°_æ•¸é‡ [Pipe(æ”¯)]'], g['8.1_3Gæ‹†å°_æ•¸é‡ [å®¤å¤–å‹å¤©ç·š(æ”¯)]'],
          g['8.1_3Gæ‹†å°_æ•¸é‡ [SMR(çµ„)]'], g['8.1_3Gæ‹†å°_æ•¸é‡ [Mini shelter/å°å‹æ©Ÿæ«ƒ(åª)]'],
          g['8.1_3Gæ‹†å°_æ•¸é‡ [é›»éŒ¶ç®±/é…é›»ç®±(åª)]'], éŒ¢éŒ¢
        ];

        const tr = document.createElement('tr');
        data.forEach((v, i) => {
          const td = document.createElement('td');
          td.textContent = v || '';
          if (i === 0) td.classList.add('tsCol');
          if (headers[i] === 'è©•åˆ†') {
            const cls = getScoreColor(v);
            if (cls) td.classList.add(cls); // é˜²æ­¢ç©ºå€¼
          }
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
  });
}


  
</script>
</body>
</html>
