<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>站台檢查記錄（最終版）</title>
  <style>
    body { font-family: sans-serif; background: #f6f6f6; padding: 1em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; table-layout: auto; }
    thead th { position: sticky; top: 0; background-color: #e0e0e0; z-index: 2; }
    th, td { padding: 0.5em; border: 1px solid #ccc; font-size: 0.9em; background: #fff; }
    td.tsCol { width: 1px !important; max-width: 1px !important; overflow: hidden; padding: 0; color: transparent; }
    .score-red { background-color: #f8d7da; color: #a94442; }
    .score-yellow { background-color: #fff3cd; color: #856404; }
    .score-green { background-color: #d4edda; color: #155724; }
  </style>
</head>
<body>
<h2>📋 站台年度檢查記錄（最終VBA轉換版）</h2>
<table id="dataTable">
  <thead>
    <tr>
      <th class="tsCol">時間戳記</th>
      <th>基地台名稱</th>
      <th>轄區</th>
      <th>型式</th>
      <th>高度(米)</th>
      <th>上期維護</th>
      <th>本次檢查</th>
      <th>檢查與改善</th>
      <th>完成日期</th>
      <th>備   註</th>
      <th>西元檢查日期</th>
      <th>評分</th>
      <th>私密備註</th>
      <th>3G拆台紀錄/施工人員</th>
      <th>主體設備(系統/射頻/電力)</th>
      <th>Pipe(支)</th>
      <th>室外型天線(支)</th>
      <th>SMR(組)</th>
      <th>Mini shelter/小型機櫃(只)</th>
      <th>電錶箱/配電箱(只)</th>
      <th>錢錢</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    <!-- JS 載入 -->
  </tbody>
</table>

<script>
const sheetURL = 'https://docs.google.com/spreadsheets/d/1ugs7DSY094iZuxkEaZZNQozSXGzSWFx_AUvh1IeTPq0/gviz/tq?tqx=out:json';
const tableBody = document.getElementById('tableBody');

function toTW(isoDate) {
  const d = new Date(isoDate);
  if (isNaN(d)) return '';
  return `民國${d.getFullYear() - 1911}年${d.getMonth() + 1}月${d.getDate()}日`;
}

function getScoreClass(score) {
  if (score === 'S') return 'score-green';
  if (score === 'A') return 'score-yellow';
  if (score === 'B') return 'score-red';
  return '';
}

function buildResl(row) {
  const 型式 = row['型式'];
  let resl = '';
  if (型式 && 型式.includes('四角')) {
    const 防墜 = row['1-2_鐵塔_防墜器'] || '';
    const 拉線數 = row['拉線數量'] || '';
    const 絞線 = row['拉線種類'] || '';
    const 拉線狀態 = row['2-1_拉線'] || '';
    const 備註 = row['2-1-1_拉線_備註'] || '';
    const 保養 = row['4_保養選項'] || '';
    const 配件備註 = row['3-3.配件_備註'] || '';
    const 其他備註 = row['4_其他_備註'] || '';
    const 配件類型 = row['配件巡檢'] || '';

    resl += (row['1-1_鐵塔_角度'] === '合格') ? '鐵塔角度合格，' : '鐵塔角度調整*******，';

    if (防墜 === '合格') resl += '防墜器檢查合格，';
    else if (防墜 === '無防墜器') resl += '無防墜器，';
    else if (防墜 === '不需防墜器') resl += '';
    else resl += '防墜器調整，';

    if (拉線狀態 === '合格') {
      resl += `拉線(${拉線數}條${絞線})檢查合格，`;
    } else {
      resl += `拉線(${拉線數}條${絞線})${拉線狀態}${備註}，`;
    }

    if (配件類型 === '配件-全部合格-柏油漆保養') {
      if (!保養.includes('未塗柏油漆')) resl += '配件塗刷柏油漆保養，';
    } else if (配件類型 === '配件-全部合格-鋼索夾') {
      if (!保養.includes('未塗柏油漆')) resl += '配件塗刷柏油漆保養，鋼索夾檢查調緊，';
    } else {
      if (!保養.includes('未塗柏油漆')) resl += '配件塗刷柏油漆保養，';
      resl += 配件備註 + '，';
    }

    resl += 其他備註 || '';
    if (row['5_除草'] === '是') resl += '以及除草';
  } else {
    resl = (row['NON-型式'] || '') + '檢查合格，';
    const arr = (row['NON-檢查與改善'] || '').split(', ').filter(s => s !== 'NOO');
    resl += arr.join('，');
    if (row['5_除草'] === '是') resl += '以及除草';
  }

  return resl.replace(/，$/, '。').replace(/。$/, '。').replace(/，，/g, '，');
}

async function loadData() {
  const res = await fetch(sheetURL);
  const text = await res.text();
  const json = JSON.parse(text.substring(47).slice(0, -2));
  const headers = json.table.cols.map(col => col.label);
  const rows = json.table.rows;

  rows.forEach(r => {
    const row = {};
    headers.forEach((h, i) => row[h] = r.c[i] ? r.c[i].v : '');
    const tr = document.createElement('tr');

    const tds = [
      ['時間戳記', 'tsCol'],
      ['基地台名稱'], ['轄區'], ['型式'], ['高度(米)'],
      ['上期維護'],
      [toTW(row['巡檢日期'] || row['時間戳記'])], // 本次檢查
      [buildResl(row)], // 檢查與改善
      ['完成日期'], ['備   註'],
      [row['巡檢日期'] || row['時間戳記']],
      [row['7_評分'], getScoreClass(row['7_評分'])],
      ['私密備註'], ['8.2_3G拆台_施工人員'], ['8.1_3G拆台_數量 [主體設備(系統/射頻/電力)]'],
      ['8.1_3G拆台_數量 [Pipe(支)]'], ['8.1_3G拆台_數量 [室外型天線(支)]'], ['8.1_3G拆台_數量 [SMR(組)]'],
      ['8.1_3G拆台_數量 [Mini shelter/小型機櫃(只)]'], ['8.1_3G拆台_數量 [電錶箱/配電箱(只)]'], ['錢錢']
    ];

    tds.forEach(([key, cls]) => {
      const td = document.createElement('td');
      td.textContent = row[key] || key;
      if (cls) td.className = cls;
      tr.appendChild(td);
    });

    tableBody.appendChild(tr);
  });
}

loadData();
</script>
</body>
</html>
