<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>站台檢查記錄（resl + 民國年）</title>
  <style>
    body { font-family: sans-serif; background: #f6f6f6; padding: 1em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; table-layout: auto; }
    thead th { position: sticky; top: 0; background-color: #e0e0e0; z-index: 2; }
    th, td { padding: 0.5em; border: 1px solid #ccc; font-size: 0.9em; background: #fff; }
    td.tsCol { width: 1px !important; max-width: 1px !important; overflow: hidden; padding: 0; color: transparent; }
    .score-red { background-color: #f8d7da; color: #a94442; }
    .score-yellow { background-color: #fff3cd; color: #856404; }
    .score-green { background-color: #d4edda; color: #155724; }
    #debug { background: #fffbe6; padding: 1em; margin-top: 1em; border: 1px dashed #aaa; font-size: 0.9em; white-space: pre-wrap; }
  </style>
</head>
<body>
<h2>📋 站台檢查（resl + 民國年邏輯）</h2>
<label>選擇年度：
  <select id="yearSelector">
    <option value="114" selected>114</option>
    <option value="113">113</option>
    <option value="112">112</option>
    <option value="custom">其他（手動輸入）</option>
  </select>
  <input type="text" id="customYearInput" placeholder="輸入年度" style="display:none;" />
</label>
<div id="debug"></div>
<table id="dataTable">
  <thead><tr id="tableHeader"></tr></thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
const sheetURL = 'https://docs.google.com/spreadsheets/d/1ugs7DSY094iZuxkEaZZNQozSXGzSWFx_AUvh1IeTPq0/gviz/tq?tqx=out:json';
const gc = [];
let headers = [], yearKey = null;
const tableHeader = document.getElementById('tableHeader');
const tableBody = document.getElementById('tableBody');
const debugDiv = document.getElementById('debug');
const yearSelector = document.getElementById('yearSelector');
const customInput = document.getElementById('customYearInput');

function logDebug(msg) {
  debugDiv.innerHTML += '> ' + msg + '\n';
}

yearSelector.addEventListener('change', () => {
  if (yearSelector.value === 'custom') {
    customInput.style.display = 'inline-block';
  } else {
    customInput.style.display = 'none';
    filterByYear(yearSelector.value);
  }
});
customInput.addEventListener('input', () => {
  filterByYear(customInput.value);
});

function toTWDate(isoDateStr) {
  if (!isoDateStr) return '';
  const d = new Date(isoDateStr);
  if (isNaN(d)) return '';
  return `民國${d.getFullYear() - 1911}年${d.getMonth()+1}月${d.getDate()}日`;
}

function getScoreClass(score) {
  switch (score) {
    case 'S': return 'score-green';
    case 'A': return 'score-yellow';
    case 'B': return 'score-red';
    default: return '';
  }
}

function buildImprovement(row) {
  let resl = '';
  const 型態 = row['鐵塔型態'];
  const flagNon = 型態 && !型態.includes('四角');

  if (!flagNon) {
    // 四角鐵塔邏輯
    const poyang = row['4_保養選項'] || '';
    const needPaint = !poyang.includes('未塗柏油漆');
    const paintText = needPaint ? '配件塗刷柏油漆保養，' : '';

    resl += (row['1-1_鐵塔_角度'] === '合格') ? '鐵塔角度合格，' : '鐵塔角度調整*******，';

    const 防墜 = row['1-2_鐵塔_防墜器'];
    if (防墜 === '合格') resl += '防墜器檢查合格，';
    else if (防墜 === '無防墜器') resl += '無防墜器，';
    else if (防墜 === '不需防墜器') resl += '';
    else resl += '防墜器調整，';

    if (row['2-1_拉線'] === '合格') {
      if (row['拉線種類'] === 'SP') {
        resl += `拉線(${row['拉線數量']})檢查合格，`;
      } else {
        resl += `拉線(${row['拉線數量']}條${row['拉線種類']})檢查合格，`;
      }
    } else {
      if (row['拉線種類'] === 'SP') {
        resl += `拉線(${row['拉線數量']})${row['2-1_拉線']}${row['2-1-1_拉線_備註']}，`;
      } else {
        resl += `拉線(${row['拉線數量']}條${row['拉線種類']})${row['2-1_拉線']}${row['2-1-1_拉線_備註']}，`;
      }
    }

    const 配件分類 = row['配件巡檢'];
    if (配件分類 === '配件-全部合格-柏油漆保養') {
      resl += paintText;
    } else if (配件分類 === '配件-全部合格-鋼索夾') {
      resl += paintText + '鋼索夾檢查調緊，';
    } else {
      resl += paintText + (row['3-3-1.配件_備註_選擇'] || '') + '，';
    }

    if (row['拉線種類'] === '*') resl = '';

    if (row['3-3.配件_備註']) resl += row['3-3.配件_備註'] + '，';
    if (row['4_其他_備註']) resl += row['4_其他_備註'];

    if (row['5_除草'] === '是') {
      resl = resl.replace(/，$/, '');
      resl += '以及除草';
    }
  } else {
    // 非四角鐵塔邏輯
    resl = row['NON-型式'] + '檢查合格，';
    const arr = (row['NON-檢查與改善'] || '').split(', ').filter(s => s && s !== 'NOO');

    if (arr.includes('鐵塔檢查合格')) {
      resl = '鐵塔檢查合格，';
      arr.splice(arr.indexOf('鐵塔檢查合格'), 1);
    }
    if (arr.includes('拉線XX條XX絞線合格')) {
      resl += `拉線(${row['NON-拉線數量']}條${row['NON-拉線種類']})檢查合格，`;
      arr.splice(arr.indexOf('拉線XX條XX絞線合格'), 1);
    }

    resl += arr.join('，');
    if (row['5_除草'] === '是') {
      resl = resl.replace(/，$/, '');
      resl += '以及除草';
    }
  }

  resl = resl.replace(/，，/g, '，').replace(/。。，/g, '，').replace(/，。/g, '，').replace(/，，/g, '，');
  if (resl.endsWith('，')) resl = resl.slice(0, -1) + '。';
  else if (!resl.endsWith('。')) resl += '。';

  return resl;
}

function renderTable(data) {
  tableHeader.innerHTML = '';
  tableBody.innerHTML = '';
  const 欄位 = ['時間戳記','站台名稱','轄區(高雄、鳳山....)','NON-型式','NON-高度(米)','上期維護','本次檢查','檢查與改善','完成日期','4_其他_備註','巡檢日期','7_評分','私密備註'];

  欄位.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h;
    tableHeader.appendChild(th);
  });

  data.forEach(row => {
    const tr = document.createElement('tr');
    欄位.forEach(h => {
      const td = document.createElement('td');
      if (h === '時間戳記') td.className = 'tsCol';
      if (h === '檢查與改善') {
        td.textContent = buildImprovement(row);
      } else if (h === '本次檢查') {
        const dateSrc = row['巡檢日期'] || row['時間戳記'];
        td.textContent = toTWDate(dateSrc);
      } else {
        td.textContent = row[h] || '';
        if (h === '7_評分') td.className = getScoreClass(row[h]);
      }
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);
  });
}

function filterByYear(year) {
  const filtered = yearKey ? gc.filter(row => row[yearKey] == year) : gc;
  logDebug(`篩選年度 ${year}，共 ${filtered.length} 筆資料`);
  renderTable(filtered);
}

async function fetchSheet() {
  const res = await fetch(sheetURL);
  const text = await res.text();
  const json = JSON.parse(text.substring(47).slice(0, -2));
  headers = json.table.cols.map(col => col.label || '');
  yearKey = headers.find(h => h.includes('年度設定')) || null;
  logDebug('取得欄位名稱：\n' + headers.join(', '));
  logDebug('使用年度欄位：' + yearKey);
  json.table.rows.forEach(row => {
    const obj = {};
    row.c.forEach((cell, i) => {
      obj[headers[i]] = cell ? cell.v : '';
    });
    gc.push(obj);
  });
  logDebug(`共載入 ${gc.length} 筆資料`);
  filterByYear('114');
}

fetchSheet();
</script>
</body>
</html>
