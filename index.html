
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç«™å°æª¢æŸ¥è¨˜éŒ„ï¼ˆVBAå½™æ•´é‚è¼¯ï¼‰</title>
  <style>
    body { font-family: sans-serif; background: #f6f6f6; padding: 1em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; table-layout: auto; }
    thead th { position: sticky; top: 0; background-color: #e0e0e0; z-index: 2; }
    th, td { padding: 0.5em; border: 1px solid #ccc; font-size: 0.9em; background: #fff; }
    .score-red { background-color: #f8d7da; color: #a94442; }
    .score-yellow { background-color: #fff3cd; color: #856404; }
    .score-green { background-color: #d4edda; color: #155724; }
    #debug { background: #fffbe6; padding: 1em; margin-top: 1em; border: 1px dashed #aaa; font-size: 0.9em; white-space: pre-wrap; }
  </style>
</head>
<body>
<h2>ğŸ“‹ ç«™å°æª¢æŸ¥ï¼ˆVBA å½™æ•´é‚è¼¯ï¼‰</h2>
<label>é¸æ“‡å¹´åº¦ï¼š
  <select id="yearSelector">
    <option value="114" selected>114</option>
    <option value="113">113</option>
    <option value="112">112</option>
    <option value="custom">å…¶ä»–ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
  </select>
  <input type="text" id="customYearInput" placeholder="è¼¸å…¥å¹´åº¦" style="display:none;" />
</label>
<div id="debug"></div>
<table id="dataTable">
  <thead><tr id="tableHeader"></tr></thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
const sheetURL = 'https://docs.google.com/spreadsheets/d/1ugs7DSY094iZuxkEaZZNQozSXGzSWFx_AUvh1IeTPq0/gviz/tq?tqx=out:json';
const gc = [];
let headers = [], yearKey = null;
const tableHeader = document.getElementById('tableHeader');
const tableBody = document.getElementById('tableBody');
const debugDiv = document.getElementById('debug');
const yearSelector = document.getElementById('yearSelector');
const customInput = document.getElementById('customYearInput');

function logDebug(msg) {
  debugDiv.innerHTML += '> ' + msg + '\n';
}

yearSelector.addEventListener('change', () => {
  if (yearSelector.value === 'custom') {
    customInput.style.display = 'inline-block';
  } else {
    customInput.style.display = 'none';
    filterByYear(yearSelector.value);
  }
});
customInput.addEventListener('input', () => {
  filterByYear(customInput.value);
});

function getScoreClass(score) {
  switch (score) {
    case 'S': return 'score-green';
    case 'A': return 'score-yellow';
    case 'B': return 'score-red';
    default: return '';
  }
}

function buildImprovement(row) {
  let result = [];

  if (row['5_é™¤è‰'] === 'æ˜¯') result.push('é™¤è‰');
  if (row['2-1_æ‹‰ç·š'] && row['2-1_æ‹‰ç·š'].includes('èª¿æ•´')) result.push('æ‹‰ç·šéœ€èª¿æ•´');

  for (let i = 1; i <= 5; i++) {
    const key = `1-1-1_éµå¡”_è§’åº¦_èª¿æ•´ [ç¬¬${i}ç¯€]`;
    if (row[key] && row[key] !== 'æ­£å¸¸') result.push(`éµå¡”ç¬¬${i}ç¯€éœ€èª¿æ•´`);
  }

  const é…ä»¶å°æ‡‰ = {
    '3_é…ä»¶ [3-1_ä¼¸å¼µå™¨]': 'ä¼¸å¼µå™¨',
    '3_é…ä»¶ [3-2_è­¦ç¤ºç®¡]': 'è­¦ç¤ºç®¡',
    '3_é…ä»¶ [3-3_ä¸‹å¤]': 'ä¸‹å¤',
    '3_é…ä»¶ [3-4_æ¯›çœ¼]': 'æ¯›çœ¼',
    '3_é…ä»¶ [3-5_ç¹ç·šå¤¾]': 'ç¹ç·šå¤¾',
    '3_é…ä»¶ [3-6_éº»å¸ƒ]': 'éº»å¸ƒ',
    '3_é…ä»¶ [3-7_é‹¼ç´¢å¤¾]': 'é‹¼ç´¢å¤¾'
  };

  Object.entries(é…ä»¶å°æ‡‰).forEach(([æ¬„ä½, åç¨±]) => {
    if (row[æ¬„ä½] && row[æ¬„ä½] !== 'åˆæ ¼') result.push(`${åç¨±}è™•ç†`);
  });

  return result.join('ã€') + (result.length ? 'ã€‚' : '');
}

function renderTable(data) {
  tableHeader.innerHTML = '';
  tableBody.innerHTML = '';
  const é¡¯ç¤ºæ¬„ä½ = [
    'æ™‚é–“æˆ³è¨˜','ç«™å°åç¨±','è½„å€(é«˜é›„ã€é³³å±±....)','NON-å‹å¼','NON-é«˜åº¦(ç±³)',
    'ä¸ŠæœŸç¶­è­·','æœ¬æ¬¡æª¢æŸ¥','æª¢æŸ¥èˆ‡æ”¹å–„','å®Œæˆæ—¥æœŸ','4_å…¶ä»–_å‚™è¨»',
    'å·¡æª¢æ—¥æœŸ','7_è©•åˆ†','ç§å¯†å‚™è¨»','8_3Gæ‹†å°','8.2_3Gæ‹†å°_æ–½å·¥äººå“¡',
    '8.1_3Gæ‹†å°_æ•¸é‡ [ä¸»é«”è¨­å‚™(ç³»çµ±/å°„é »/é›»åŠ›)]','8.1_3Gæ‹†å°_æ•¸é‡ [Pipe(æ”¯)]','8.1_3Gæ‹†å°_æ•¸é‡ [å®¤å¤–å‹å¤©ç·š(æ”¯)]',
    '8.1_3Gæ‹†å°_æ•¸é‡ [SMR(çµ„)]','8.1_3Gæ‹†å°_æ•¸é‡ [Mini shelter/å°å‹æ©Ÿæ«ƒ(åª)]','8.1_3Gæ‹†å°_æ•¸é‡ [é›»éŒ¶ç®±/é…é›»ç®±(åª)]','éŒ¢éŒ¢'
  ];
  é¡¯ç¤ºæ¬„ä½.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h;
    tableHeader.appendChild(th);
  });

  data.forEach(row => {
    const tr = document.createElement('tr');
    é¡¯ç¤ºæ¬„ä½.forEach(h => {
      const td = document.createElement('td');
      if (h === 'æª¢æŸ¥èˆ‡æ”¹å–„') {
        td.textContent = buildImprovement(row);
      } else {
        td.textContent = row[h] || '';
        if (h === '7_è©•åˆ†') td.className = getScoreClass(row[h]);
      }
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);
  });
}

function filterByYear(year) {
  const filtered = yearKey ? gc.filter(row => row[yearKey] == year) : gc;
  logDebug(`ç¯©é¸å¹´åº¦ ${year}ï¼Œå…± ${filtered.length} ç­†è³‡æ–™`);
  renderTable(filtered);
}

async function fetchSheet() {
  const res = await fetch(sheetURL);
  const text = await res.text();
  const json = JSON.parse(text.substring(47).slice(0, -2));
  headers = json.table.cols.map(col => col.label || '');
  yearKey = headers.find(h => h.includes('å¹´åº¦è¨­å®š')) || null;
  logDebug('å–å¾—æ¬„ä½åç¨±ï¼š\n' + headers.join(', '));
  logDebug('ä½¿ç”¨å¹´åº¦æ¬„ä½ï¼š' + yearKey);
  json.table.rows.forEach(row => {
    const obj = {};
    row.c.forEach((cell, i) => {
      obj[headers[i]] = cell ? cell.v : '';
    });
    gc.push(obj);
  });
  logDebug(`å…±è¼‰å…¥ ${gc.length} ç­†è³‡æ–™`);
  filterByYear('114');
}

fetchSheet();
</script>
</body>
</html>
