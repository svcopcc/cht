<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç«™å°æª¢æŸ¥è¨˜éŒ„ï¼ˆresl + æ°‘åœ‹å¹´ï¼‰</title>
  <style>
    body { font-family: sans-serif; background: #f6f6f6; padding: 1em; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; table-layout: auto; }
    thead th { position: sticky; top: 0; background-color: #e0e0e0; z-index: 2; }
    th, td { padding: 0.5em; border: 1px solid #ccc; font-size: 0.9em; background: #fff; }
    td.tsCol { width: 1px !important; max-width: 1px !important; overflow: hidden; padding: 0; color: transparent; }
    .score-red { background-color: #f8d7da; color: #a94442; }
    .score-yellow { background-color: #fff3cd; color: #856404; }
    .score-green { background-color: #d4edda; color: #155724; }
    #debug { background: #fffbe6; padding: 1em; margin-top: 1em; border: 1px dashed #aaa; font-size: 0.9em; white-space: pre-wrap; }
  </style>
</head>
<body>
<h2>ğŸ“‹ ç«™å°æª¢æŸ¥ï¼ˆresl + æ°‘åœ‹å¹´é‚è¼¯ï¼‰</h2>
<label>é¸æ“‡å¹´åº¦ï¼š
  <select id="yearSelector">
    <option value="114" selected>114</option>
    <option value="113">113</option>
    <option value="112">112</option>
    <option value="custom">å…¶ä»–ï¼ˆæ‰‹å‹•è¼¸å…¥ï¼‰</option>
  </select>
  <input type="text" id="customYearInput" placeholder="è¼¸å…¥å¹´åº¦" style="display:none;" />
</label>
<div id="debug"></div>
<table id="dataTable">
  <thead><tr id="tableHeader"></tr></thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
const sheetURL = 'https://docs.google.com/spreadsheets/d/1ugs7DSY094iZuxkEaZZNQozSXGzSWFx_AUvh1IeTPq0/gviz/tq?tqx=out:json';
const gc = [];
let headers = [], yearKey = null;
const tableHeader = document.getElementById('tableHeader');
const tableBody = document.getElementById('tableBody');
const debugDiv = document.getElementById('debug');
const yearSelector = document.getElementById('yearSelector');
const customInput = document.getElementById('customYearInput');

function logDebug(msg) {
  debugDiv.innerHTML += '> ' + msg + '\n';
}

yearSelector.addEventListener('change', () => {
  if (yearSelector.value === 'custom') {
    customInput.style.display = 'inline-block';
  } else {
    customInput.style.display = 'none';
    filterByYear(yearSelector.value);
  }
});
customInput.addEventListener('input', () => {
  filterByYear(customInput.value);
});

function toTWDate(isoDateStr) {
  if (!isoDateStr) return '';
  const d = new Date(isoDateStr);
  if (isNaN(d)) return '';
  return `æ°‘åœ‹${d.getFullYear() - 1911}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
}

function getScoreClass(score) {
  switch (score) {
    case 'S': return 'score-green';
    case 'A': return 'score-yellow';
    case 'B': return 'score-red';
    default: return '';
  }
}

function buildImprovement(row) {
  let resl = '';
  const å‹æ…‹ = row['éµå¡”å‹æ…‹'];
  const flagNon = å‹æ…‹ && !å‹æ…‹.includes('å››è§’');

  if (!flagNon) {
    // å››è§’éµå¡”é‚è¼¯
    const poyang = row['4_ä¿é¤Šé¸é …'] || '';
    const needPaint = !poyang.includes('æœªå¡—æŸæ²¹æ¼†');
    const paintText = needPaint ? 'é…ä»¶å¡—åˆ·æŸæ²¹æ¼†ä¿é¤Šï¼Œ' : '';

    resl += (row['1-1_éµå¡”_è§’åº¦'] === 'åˆæ ¼') ? 'éµå¡”è§’åº¦åˆæ ¼ï¼Œ' : 'éµå¡”è§’åº¦èª¿æ•´*******ï¼Œ';

    const é˜²å¢œ = row['1-2_éµå¡”_é˜²å¢œå™¨'];
    if (é˜²å¢œ === 'åˆæ ¼') resl += 'é˜²å¢œå™¨æª¢æŸ¥åˆæ ¼ï¼Œ';
    else if (é˜²å¢œ === 'ç„¡é˜²å¢œå™¨') resl += 'ç„¡é˜²å¢œå™¨ï¼Œ';
    else if (é˜²å¢œ === 'ä¸éœ€é˜²å¢œå™¨') resl += '';
    else resl += 'é˜²å¢œå™¨èª¿æ•´ï¼Œ';

    if (row['2-1_æ‹‰ç·š'] === 'åˆæ ¼') {
      if (row['æ‹‰ç·šç¨®é¡'] === 'SP') {
        resl += `æ‹‰ç·š(${row['æ‹‰ç·šæ•¸é‡']})æª¢æŸ¥åˆæ ¼ï¼Œ`;
      } else {
        resl += `æ‹‰ç·š(${row['æ‹‰ç·šæ•¸é‡']}æ¢${row['æ‹‰ç·šç¨®é¡']})æª¢æŸ¥åˆæ ¼ï¼Œ`;
      }
    } else {
      if (row['æ‹‰ç·šç¨®é¡'] === 'SP') {
        resl += `æ‹‰ç·š(${row['æ‹‰ç·šæ•¸é‡']})${row['2-1_æ‹‰ç·š']}${row['2-1-1_æ‹‰ç·š_å‚™è¨»']}ï¼Œ`;
      } else {
        resl += `æ‹‰ç·š(${row['æ‹‰ç·šæ•¸é‡']}æ¢${row['æ‹‰ç·šç¨®é¡']})${row['2-1_æ‹‰ç·š']}${row['2-1-1_æ‹‰ç·š_å‚™è¨»']}ï¼Œ`;
      }
    }

    const é…ä»¶åˆ†é¡ = row['é…ä»¶å·¡æª¢'];
    if (é…ä»¶åˆ†é¡ === 'é…ä»¶-å…¨éƒ¨åˆæ ¼-æŸæ²¹æ¼†ä¿é¤Š') {
      resl += paintText;
    } else if (é…ä»¶åˆ†é¡ === 'é…ä»¶-å…¨éƒ¨åˆæ ¼-é‹¼ç´¢å¤¾') {
      resl += paintText + 'é‹¼ç´¢å¤¾æª¢æŸ¥èª¿ç·Šï¼Œ';
    } else {
      resl += paintText + (row['3-3-1.é…ä»¶_å‚™è¨»_é¸æ“‡'] || '') + 'ï¼Œ';
    }

    if (row['æ‹‰ç·šç¨®é¡'] === '*') resl = '';

    if (row['3-3.é…ä»¶_å‚™è¨»']) resl += row['3-3.é…ä»¶_å‚™è¨»'] + 'ï¼Œ';
    if (row['4_å…¶ä»–_å‚™è¨»']) resl += row['4_å…¶ä»–_å‚™è¨»'];

    if (row['5_é™¤è‰'] === 'æ˜¯') {
      resl = resl.replace(/ï¼Œ$/, '');
      resl += 'ä»¥åŠé™¤è‰';
    }
  } else {
    // éå››è§’éµå¡”é‚è¼¯
    resl = row['NON-å‹å¼'] + 'æª¢æŸ¥åˆæ ¼ï¼Œ';
    const arr = (row['NON-æª¢æŸ¥èˆ‡æ”¹å–„'] || '').split(', ').filter(s => s && s !== 'NOO');

    if (arr.includes('éµå¡”æª¢æŸ¥åˆæ ¼')) {
      resl = 'éµå¡”æª¢æŸ¥åˆæ ¼ï¼Œ';
      arr.splice(arr.indexOf('éµå¡”æª¢æŸ¥åˆæ ¼'), 1);
    }
    if (arr.includes('æ‹‰ç·šXXæ¢XXçµç·šåˆæ ¼')) {
      resl += `æ‹‰ç·š(${row['NON-æ‹‰ç·šæ•¸é‡']}æ¢${row['NON-æ‹‰ç·šç¨®é¡']})æª¢æŸ¥åˆæ ¼ï¼Œ`;
      arr.splice(arr.indexOf('æ‹‰ç·šXXæ¢XXçµç·šåˆæ ¼'), 1);
    }

    resl += arr.join('ï¼Œ');
    if (row['5_é™¤è‰'] === 'æ˜¯') {
      resl = resl.replace(/ï¼Œ$/, '');
      resl += 'ä»¥åŠé™¤è‰';
    }
  }

  resl = resl.replace(/ï¼Œï¼Œ/g, 'ï¼Œ').replace(/ã€‚ã€‚ï¼Œ/g, 'ï¼Œ').replace(/ï¼Œã€‚/g, 'ï¼Œ').replace(/ï¼Œï¼Œ/g, 'ï¼Œ');
  if (resl.endsWith('ï¼Œ')) resl = resl.slice(0, -1) + 'ã€‚';
  else if (!resl.endsWith('ã€‚')) resl += 'ã€‚';

  return resl;
}

function renderTable(data) {
  tableHeader.innerHTML = '';
  tableBody.innerHTML = '';
  const æ¬„ä½ = ['æ™‚é–“æˆ³è¨˜','ç«™å°åç¨±','è½„å€(é«˜é›„ã€é³³å±±....)','NON-å‹å¼','NON-é«˜åº¦(ç±³)','ä¸ŠæœŸç¶­è­·','æœ¬æ¬¡æª¢æŸ¥','æª¢æŸ¥èˆ‡æ”¹å–„','å®Œæˆæ—¥æœŸ','4_å…¶ä»–_å‚™è¨»','å·¡æª¢æ—¥æœŸ','7_è©•åˆ†','ç§å¯†å‚™è¨»'];

  æ¬„ä½.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h;
    tableHeader.appendChild(th);
  });

  data.forEach(row => {
    const tr = document.createElement('tr');
    æ¬„ä½.forEach(h => {
      const td = document.createElement('td');
      if (h === 'æ™‚é–“æˆ³è¨˜') td.className = 'tsCol';
      if (h === 'æª¢æŸ¥èˆ‡æ”¹å–„') {
        td.textContent = buildImprovement(row);
      } else if (h === 'æœ¬æ¬¡æª¢æŸ¥') {
        const dateSrc = row['å·¡æª¢æ—¥æœŸ'] || row['æ™‚é–“æˆ³è¨˜'];
        td.textContent = toTWDate(dateSrc);
      } else {
        td.textContent = row[h] || '';
        if (h === '7_è©•åˆ†') td.className = getScoreClass(row[h]);
      }
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);
  });
}

function filterByYear(year) {
  const filtered = yearKey ? gc.filter(row => row[yearKey] == year) : gc;
  logDebug(`ç¯©é¸å¹´åº¦ ${year}ï¼Œå…± ${filtered.length} ç­†è³‡æ–™`);
  renderTable(filtered);
}

async function fetchSheet() {
  const res = await fetch(sheetURL);
  const text = await res.text();
  const json = JSON.parse(text.substring(47).slice(0, -2));
  headers = json.table.cols.map(col => col.label || '');
  yearKey = headers.find(h => h.includes('å¹´åº¦è¨­å®š')) || null;
  logDebug('å–å¾—æ¬„ä½åç¨±ï¼š\n' + headers.join(', '));
  logDebug('ä½¿ç”¨å¹´åº¦æ¬„ä½ï¼š' + yearKey);
  json.table.rows.forEach(row => {
    const obj = {};
    row.c.forEach((cell, i) => {
      obj[headers[i]] = cell ? cell.v : '';
    });
    gc.push(obj);
  });
  logDebug(`å…±è¼‰å…¥ ${gc.length} ç­†è³‡æ–™`);
  filterByYear('114');
}

fetchSheet();
</script>
</body>
</html>
